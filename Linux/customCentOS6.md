# 制作CentOS 6.5一键自安装ISO镜像光盘
转载于[这里](http://yangfannie.com/771.html)

[TOC]
## 系统安装包说明
目录树结构
```
|-- .discinfo
|-- .treeinfo
|-- CentOS
|-- base
|-- images
|-- isolinux
|-- ks.cfg
|-- repodata
```

.discinfo 文件是安装价质的识别信息
.treeinfo 文件是系统版本，创建时间及文件目录树结构信息
CentOS目录存放安装软件包及信息(Centos 6版本的名称是Packages)
base 目录存放定制脚本及包信息
images 目录包括了必要的启动映像文件
isolinux 目录存放光盘启动时的安装界面信息
ks.cfg 文件是无人值守自动化安装配置文件

## 挂载光盘
1. 先到官网下载所需的ISO版本。点击这里下载
2. 安装制作发行版的工具
```bash
yum -y install anaconda repodata createrepo mkisofs rsync
```
3. 挂载光盘，同步文件
```bash
mkdir /mnt/cdrom

## 挂载iso到/mnt/cdrom文件下
mount -o loop CentOS-6.5-x86_64-bin-DVD1.iso /mnt/cdrom/   

##同步/mnt/cdrom/下的文件到ISO/路径下，除了Packages和repodata文件夹
/usr/bin/rsync -a --exclude=Packages/ --exclude=repodata/ /mnt/cdrom/ /ISO/ 

##在ISO/文件夹下新建Packages和repodata文件夹
mkdir -p /ISO/{Packages,repodata}  
```
4. 使用脚本拷贝相关软件包到/ISO/Packages目录下

> PS：脚本中的install.log文件可以从/root目录下获取，目的是可以删除不必要的rpm包

```bash
#!/bin/bash
cd /root
awk '/Installing/{print $2}' install.log | sed 's/^*://g' >package.txt
DVD='/mnt/cdrom/Packages'
NEW_DVD='/ISO/Packages'
while read LINE
do
cp ${DVD}/${LINE}*.rpm /${NEW_DVD} || echo "$LINE don't cp......."
done < package.txt
rm -f package.txt
```

## 定制安装脚本ks.cfg文件
ks.cfg
```
# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
lang en_US.UTF-8
keyboard us
network --onboot yes --device eth0 --bootproto dhcp --noipv6
rootpw  --iscrypted $6$V9GIM6eq3C4nxw3t$iLzSw3n/boLsXRn4ksVkgLxUtiMCMvWzFFELGfzGKwyjkWXodaGwo1GPMw/DIHaE4uj5C2$
fTKuW9IJMMQyw3.
firewall --service=ssh
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone --utc Asia/Shanghai
bootloader --location=partition --driveorder=sda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --all --drives=sda

#part /boot/efi --fstype=efi --grow --maxsize=200 --size=50
#part /boot --fstype=ext4 --size=500
#part / --fstype=ext4 --asprimary --size=20480
#part swap --asprimary --size=4096
#part /home --fstype=ext4 --grow --asprimary --size=200

#part None --fstype=efi --label="CentOS_6.5_" --onpart=sdb4 --noformat                                

clearpart --all --drives=sda
part /boot --fstype=ext4 --size=500 --ondisk=sda
part /home --fstype=ext4 --grow --size=1 --ondisk=sda
part /  --fstype=ext4 --size=10000 --ondisk=sda
part swap --recommended --ondisk=sda

#repo --name="CentOS"  --baseurl=hd:/dev/sdb4:/ --cost=100

%packages
@additional-devel
@base
@core
@debugging
@basic-desktop
@desktop-debugging
@desktop-platform
@desktop-platform-devel
@development
@directory-client
@eclipse
@emacs
@fonts
@general-desktop
@graphical-admin-tools
@graphics
@input-methods
@java-platform
@legacy-x
@network-file-system-client
@performance
@perl-runtime
@print-client
@remote-desktop-clients
@server-platform
@server-platform-devel
@server-policy
@tex
@technical-writing
@virtualization
@virtualization-client
@virtualization-platform
@workstation-policy
@x11
libgcrypt-devel
libXinerama-devel
openmotif-devel
libXmu-devel
xorg-x11-proto-devel
startup-notification-devel
libgnomeui-devel
libbonobo-devel
junit
libXau-devel
popt-devel
gnome-python2-desktop
libdrm-devel
libxslt-devel
libglade2-devel
gnutls-devel
mtools
pax
oddjob
wodim
sgpio
genisoimage
device-mapper-persistent-data
systemtap-client
abrt-gui
desktop-file-utils
ant
rpmdevtools
jpackage-utils
rpmlint
samba-winbind
certmonger
pam_krb5
krb5-workstation
netpbm-progs
openmotif
libXmu
libXp
perl-DBD-SQLite
libvirt-java
%end

# custom
%post
id media &> /dev/null || useradd media
echo "password" | passwd -stdin media

echo "abcdef" > /log.log

%end

```

## 修改isolinux.cfg文件
vim isolinux/isolinux.cfg
```
label linux
 menu label ^Install or upgrade an existing system
 menu default
 kernel vmlinuz
 append ks=cdrom:/ks.cfg initrd=initrd.img    ##修改成定制ks.cfg所在目录
```
## 生成comps.xml文件
1、进入/mnt/cdrom/repodata 目录，将“*-x86_64-comps.xml”文件拷贝到/ISO/repodata路径下，并重命名成comps.xml。由于centos6.5下的comps.xml文件名很长，这里“*”为省略符，实际操作时输入完整文件名。

```bash
cp /mnt/cdrom/repodata/*-x86_64.xml  /ISO/repodata/comps.xml
```

2、切换到ISO/路径下，生成comps.xml文件
```bash
createrepo -g repodata/comps.xml ./
declare -x discinfo=`head -1 .discinfo`
createrepo -u "media://$discinfo" -g repodata/comps.xml .
```

> PS：如果有新增或删除了Packages目录的RPM包，请重新生成comps.xml文件

## 生成ISO文件
到这步实际定制配置系统的工作已经完成了。下面就是生成一个ISO镜像文件，便于刻录到光盘中进行安装。
```bash
mkisofs -o CentOS-6.5_x86_64.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -R -J -v -T /ISO/
```

> PS：/ISO/目录下产生的CentOS-6.5_x86_64.iso就是生成的ISO文件，路径和ISO名称都可以自定义。

## 生成ISO文件MD5值
```bash
/usr/bin/implantisomd5 /ISO/CentOS-6.5_x86_64.iso
```

